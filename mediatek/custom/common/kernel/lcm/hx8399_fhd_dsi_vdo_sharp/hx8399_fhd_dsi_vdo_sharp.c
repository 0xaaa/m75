#ifndef BUILD_LK
#include <linux/string.h>
#endif
#include "lcm_drv.h"
#include <cust_gpio_usage.h>
#ifdef BUILD_LK
#include <platform/mt_gpio.h>
#include <string.h>
#elif defined(BUILD_UBOOT)
#include <asm/arch/mt_gpio.h>
#else
#include <mach/mt_gpio.h>
#include <mach/mt_pm_ldo.h>
#endif
// ---------------------------------------------------------------------------
//  Local Constants
// ---------------------------------------------------------------------------

#define FRAME_WIDTH  (1152)
#define FRAME_HEIGHT (1920)
#define REGFLAG_DELAY 0xffe
#define REGFLAG_END_OF_TABLE 0xfff

#ifndef BUILD_LK
#define lcm_print(fmt, args...) pr_debug(fmt, ##args)
#else
#define lcm_print(fmt, args...) printf(fmt, ##args)
//static unsigned int lcm_esd_test = FALSE;      ///only for ESD test
#endif
// ---------------------------------------------------------------------------
//  Local Variables
// ---------------------------------------------------------------------------

static LCM_UTIL_FUNCS lcm_util;

#define SET_RESET_PIN(v)    (lcm_util.set_reset_pin((v)))

#define UDELAY(n) (lcm_util.udelay(n))
#define MDELAY(n) (lcm_util.mdelay(n))

//#define POWER_MODE_5


// ---------------------------------------------------------------------------
//  Local Functions
// ---------------------------------------------------------------------------
#define dsi_set_cmdq_V3(para_tbl,size,force_update)        lcm_util.dsi_set_cmdq_V3(para_tbl,size,force_update)
#define dsi_set_cmdq_V2(cmd, count, ppara, force_update)	        lcm_util.dsi_set_cmdq_V2(cmd, count, ppara, force_update)
#define dsi_set_cmdq(pdata, queue_size, force_update)		lcm_util.dsi_set_cmdq(pdata, queue_size, force_update)
#define wrtie_cmd(cmd)										lcm_util.dsi_write_cmd(cmd)
#define write_regs(addr, pdata, byte_nums)					lcm_util.dsi_write_regs(addr, pdata, byte_nums)
#define read_reg(cmd)											lcm_util.dsi_dcs_read_lcm_reg(cmd)
#define read_reg_v2(cmd, buffer, buffer_size)   				lcm_util.dsi_dcs_read_lcm_reg_v2(cmd, buffer, buffer_size)

#define   LCM_DSI_CMD_MODE							0

struct LCM_setting_table {
	unsigned cmd;
	unsigned char count;
	unsigned char para_list[64];
};

static struct LCM_setting_table sharp_init_code[] = {
	{0xb9, 3,  {0xff,0x83,0x99}},
#ifdef POWER_MODE_5
	{0xb0, 3,  {0x00,0x00,0x65}},
#endif
	{0xb1, 12, {0x00,0x7C,0x38,0x35,0x99,0x09,0x22,0x22,0x72,0xf2,0x68,0x58}},
	{0xb2, 10, {0x00,0x80,0x10,0x7f,0x05,0x01,0x23,0x4d,0x21,0x01}},
	{0xb4, 40, {0x00,0x3F,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x40,0x00,0x00,0x3A,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x00,0x00,0x00,0x3A}},
	{0xba, 4,  {0x03,0x82,0xa0,0xe5}},
#ifdef POWER_MODE_5
	{0xbf, 12, {0xCF,0x00,0x46}},
#endif
	{0xd3, 31, {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x10,0x05,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x03,0x00,0x00,0x00,0x05,0x08}},
	{0xd5, 32, {0x00,0x00,0x01,0x00,0x03,0x02,0x00,0x00,0x00,0x00,0x19,0x00,0x18,0x00,0x21,0x20,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd6, 32, {0x40,0x40,0x02,0x03,0x00,0x01,0x40,0x40,0x40,0x40,0x18,0x40,0x19,0x40,0x20,0x21,0x40,0x18,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd8, 48, {0x28,0x2A,0x00,0x2A,0x28,0x02,0xC0,0x2A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x02,0x00,0x2A,0x28,0x02,0xC0,0x2A}},
	{0xd2, 1,  {0x99}},
	{REGFLAG_END_OF_TABLE, 0, {}},
};

static struct LCM_setting_table sharp_init_code_id30[] = {
	{0xb9, 3,  {0xff,0x83,0x99}},
#ifdef POWER_MODE_5
	{0xb0, 3,  {0x00,0x00,0x65}},
#endif
	{0xe0, 42, {0x04,0x12,0x19,0x32,0x36,0x3E,0x2A,0x46,0x07,0x0E,0x0E,0x11,0x13,0x11,0x13,0x14,0x16,0x0C,0x18,0x0A,0x15,0x04,0x12,0x19,0x32,0x36,0x3E,0x2A,0x46,0x07,0x0E,0x0E,0x11,0x13,0x11,0x13,0x14,0x16,0x0C,0x18,0x0A,0x15}},
	{0xb1, 12, {0x00,0x7C,0x37,0x37,0x99,0x09,0x22,0x22,0x72,0xf2,0x68,0x58}},
	{0xd2, 1, {0x99}},
	{0xd3, 31, {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x10,0x05,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x03,0x00,0x00,0x00,0x05,0x08}},
	{0xd5, 32, {0x00,0x00,0x01,0x00,0x03,0x02,0x00,0x00,0x00,0x00,0x19,0x00,0x18,0x00,0x21,0x20,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd6, 32, {0x40,0x40,0x02,0x03,0x00,0x01,0x40,0x40,0x40,0x40,0x18,0x40,0x19,0x40,0x20,0x21,0x40,0x18,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd8, 48, {0x28,0x2A,0x00,0x2A,0x28,0x02,0xC0,0x2A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x02,0x00,0x2A,0x28,0x02,0xC0,0x2A}},
	{0xb2, 10, {0x00,0x80,0x10,0x7f,0x05,0x01,0x23,0x4d,0x21,0x01}},
	{0xb4, 40, {0x00,0x3F,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x40,0x00,0x00,0x3A,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x00,0x00,0x00,0x3A}},
	{0xba, 4,  {0x03,0x82,0xa0,0xe5}},
#ifdef POWER_MODE_5
	{0xbf, 12, {0xCF,0x00,0x46}},
#endif
	{0xc1, 43, {0x01,0x00,0x07,0x0C,0x14,0x1B,0x24,0x2C,0x33,0x3D,0x47,0x4E,0x56,0x5D,0x64,0x6D,0x75,0x7D,0x84,0x8B,0x93,0x9B,0xA3,0xAB,0xB3,0xBA,0xC1,0xCB,0xD2,0xDA,0xE2,0xEA,0xF1,0xF9,0x10,0x40,0x89,0x39,0xAF,0x8A,0x31,0x99,0x40}},
	{0xbd, 1, {0x01}},
	{0xc1, 42, {0x00,0x07,0x0C,0x14,0x1B,0x24,0x2C,0x33,0x3D,0x47,0x4E,0x56,0x5D,0x64,0x6D,0x75,0x7D,0x84,0x8B,0x93,0x9B,0xA3,0xAB,0xB3,0xBA,0xC1,0xCB,0xD2,0xDA,0xE2,0xEA,0xF1,0xF9,0x10,0x40,0x89,0x39,0xAF,0x8A,0x31,0x99,0x40}},
	{0xbd, 1, {0x02}},
	{0xc1, 42, {0x00,0x07,0x0C,0x14,0x1C,0x25,0x2D,0x34,0x3F,0x48,0x4F,0x57,0x5E,0x66,0x6F,0x77,0x7F,0x86,0x8D,0x96,0x9C,0xA4,0xAD,0xB4,0xBC,0xC5,0xCD,0xD5,0xDD,0xE6,0xEF,0xF6,0xFF,0x16,0x00,0x2E,0x54,0x6C,0xE2,0x8F,0x44,0xC0}},
	{0xbd, 1, {0x00}},
	{REGFLAG_END_OF_TABLE, 0, {}},
};

static struct LCM_setting_table sharp_init_code_id31[] = {
	{0xb9, 3,  {0xff,0x83,0x99}},
#ifdef POWER_MODE_5
	{0xb0, 3,  {0x00,0x00,0x65}},
#endif
	{0xe0, 42, {0x01,0x13,0x17,0x34,0x38,0x3E,0x2C,0x47,0x07,0x0C,0x0F,0x12,0x14,0x11,0x13,0x12,0x18,0x0B,0x17,0x07,0x13,0x02,0x14,0x18,0x32,0x37,0x3D,0x29,0x43,0x07,0x0E,0x0C,0x0F,0x11,0x10,0x12,0x12,0x18,0x0C,0x17,0x07,0x13}},
	{0xb1, 12, {0x00,0x7C,0x38,0x35,0x99,0x09,0x22,0x22,0x72,0xf2,0x68,0x58}},
	{0xd2, 1, {0x99}},
	{0xd3, 31, {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x10,0x05,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x03,0x00,0x00,0x00,0x05,0x08}},
	{0xd5, 32, {0x00,0x00,0x01,0x00,0x03,0x02,0x00,0x00,0x00,0x00,0x19,0x00,0x18,0x00,0x21,0x20,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd6, 32, {0x40,0x40,0x02,0x03,0x00,0x01,0x40,0x40,0x40,0x40,0x18,0x40,0x19,0x40,0x20,0x21,0x40,0x18,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd8, 48, {0x28,0x2A,0x00,0x2A,0x28,0x02,0xC0,0x2A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x02,0x00,0x2A,0x28,0x02,0xC0,0x2A}},
	{0xb2, 10, {0x00,0x80,0x10,0x7f,0x05,0x01,0x23,0x4d,0x21,0x01}},
	{0xb4, 40, {0x00,0x3F,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x40,0x00,0x00,0x3A,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x00,0x00,0x00,0x3A}},
	{0xba, 4,  {0x03,0x82,0xa0,0xe5}},
#ifdef POWER_MODE_5
	{0xbf, 12, {0xCF,0x00,0x46}},
#endif
#if 0
	{0xc1, 43, {0x01,0x00,0x07,0x0C,0x14,0x1B,0x24,0x2C,0x33,0x3D,0x47,0x4E,0x56,0x5D,0x64,0x6D,0x75,0x7D,0x84,0x8B,0x93,0x9B,0xA3,0xAB,0xB3,0xBA,0xC1,0xCB,0xD2,0xDA,0xE2,0xEA,0xF1,0xF9,0x10,0x40,0x89,0x39,0xAF,0x8A,0x31,0x99,0x40}},
	{0xbd, 1, {0x01}},
	{0xc1, 42, {0x00,0x07,0x0C,0x14,0x1B,0x24,0x2C,0x33,0x3D,0x47,0x4E,0x56,0x5D,0x64,0x6D,0x75,0x7D,0x84,0x8B,0x93,0x9B,0xA3,0xAB,0xB3,0xBA,0xC1,0xCB,0xD2,0xDA,0xE2,0xEA,0xF1,0xF9,0x10,0x40,0x89,0x39,0xAF,0x8A,0x31,0x99,0x40}},
	{0xbd, 1, {0x02}},
	{0xc1, 42, {0x00,0x07,0x0C,0x14,0x1C,0x25,0x2D,0x34,0x3F,0x48,0x4F,0x57,0x5E,0x66,0x6F,0x77,0x7F,0x86,0x8D,0x96,0x9C,0xA4,0xAD,0xB4,0xBC,0xC5,0xCD,0xD5,0xDD,0xE6,0xEF,0xF6,0xFF,0x16,0x00,0x2E,0x54,0x6C,0xE2,0x8F,0x44,0xC0}},
	{0xbd, 1, {0x00}},
#endif
	{REGFLAG_END_OF_TABLE, 0, {}},
};

static struct LCM_setting_table sharp_init_code_id32[] = {
	{0xb9, 3,  {0xff,0x83,0x99}},
#ifdef POWER_MODE_5
	{0xb0, 3,  {0x00,0x00,0x65}},
#endif
	{0xe0, 42, {0x04,0x12,0x19,0x32,0x36,0x3E,0x2A,0x46,0x07,0x0E,0x0E,0x11,0x13,0x11,0x13,0x14,0x16,0x0C,0x18,0x0A,0x15,0x04,0x12,0x19,0x32,0x36,0x3E,0x2A,0x46,0x07,0x0E,0x0E,0x11,0x13,0x11,0x13,0x14,0x16,0x0C,0x18,0x0A,0x15}},
	{0xb1, 12, {0x00,0x7C,0x37,0x37,0x99,0x09,0x22,0x22,0x72,0xf2,0x68,0x58}},
	{0xd2, 1, {0x99}},
	{0xd3, 31, {0x00,0x00,0x00,0x00,0x00,0x30,0x30,0x00,0x10,0x05,0x00,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x07,0x07,0x03,0x00,0x00,0x00,0x05,0x08}},
	{0xd5, 32, {0x00,0x00,0x01,0x00,0x03,0x02,0x00,0x00,0x00,0x00,0x19,0x00,0x18,0x00,0x21,0x20,0x00,0x18,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd6, 32, {0x40,0x40,0x02,0x03,0x00,0x01,0x40,0x40,0x40,0x40,0x18,0x40,0x19,0x40,0x20,0x21,0x40,0x18,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x40,0x32,0x32,0x31,0x31,0x30,0x30}},
	{0xd8, 48, {0x28,0x2A,0x00,0x2A,0x28,0x02,0xC0,0x2A,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x28,0x02,0x00,0x2A,0x28,0x02,0xC0,0x2A}},
	{0xb2, 10, {0x00,0x80,0x10,0x7f,0x05,0x01,0x23,0x4d,0x21,0x01}},
	{0xb4, 40, {0x00,0x3F,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x40,0x00,0x00,0x3A,0x00,0x41,0x00,0x3D,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x0F,0x01,0x02,0x05,0x00,0x00,0x00,0x3A}},
	{0xba, 4,  {0x03,0x82,0xa0,0xe5}},
#ifdef POWER_MODE_5
	{0xbf, 12, {0xCF,0x00,0x46}},
#endif
	{0xc1, 43, {0x01,0x00,0x07,0x0C,0x14,0x1B,0x24,0x2C,0x33,0x3F,0x48,0x50,0x57,0x5F,0x67,0x70,0x78,0x80,0x88,0x8E,0x98,0x9F,0xA6,0xAE,0xB6,0xBE,0xC7,0xCF,0xD7,0xDF,0xE8,0xEF,0xF8,0xFF,0x16,0x03,0x2E,0x54,0x6C,0xE2,0x8F,0x44,0xC0}},
	{0xbd, 1, {0x01}},
	{0xc1, 42, {0x00,0x07,0x0C,0x14,0x1B,0x24,0x2C,0x33,0x3F,0x48,0x50,0x57,0x5F,0x67,0x70,0x78,0x80,0x88,0x8E,0x98,0x9F,0xA6,0xAE,0xB6,0xBE,0xC7,0xCF,0xD7,0xDF,0xE8,0xEF,0xF8,0xFF,0x16,0x03,0x2E,0x54,0x6C,0xE2,0x8F,0x44,0xC0}},
	{0xbd, 1, {0x02}},
	{0xc1, 42, {0x00,0x07,0x0C,0x14,0x1A,0x23,0x2B,0x32,0x3D,0x47,0x4F,0x56,0x5E,0x65,0x6E,0x76,0x7E,0x86,0x8C,0x95,0x9E,0xA5,0xAB,0xB4,0xBB,0xC2,0xCB,0xD3,0xDB,0xE3,0xEA,0xEF,0xF9,0x10,0x43,0x89,0x39,0xAF,0x8A,0x31,0x99,0x40}},
	{0xbd, 1, {0x00}},
	{REGFLAG_END_OF_TABLE, 0, {}},
};

static struct LCM_setting_table sharp_gamma_setting_v3[] = {
	{0xb9, 3,  {0xff,0x83,0x99}},
	{0xe0, 42, {0x01,0x13,0x19,0x38,0x3B,0x3E,0x2D,0x4B,0x07,0x0D,0x0E,0x12,0x12,0x11,0x13,0x15,0x19,0x0B,0x17,0x09,0x14,0x02,0x14,0x1A,0x37,0x3A,0x3D,0x2A,0x48,0x08,0x0F,0x0C,0x0E,0x0F,0x0F,0x11,0x14,0x19,0x0C,0x17,0x08,0x14}},
	{REGFLAG_END_OF_TABLE, 0, {}},
};

static struct LCM_setting_table sharp_slpout[] = {
	/*sleep out*/
	{0x11, 1, {0}},
	{REGFLAG_DELAY, 120, {}},
	/*display on*/
	{0x35, 1, {0}},
	{REGFLAG_END_OF_TABLE, 0, {}},
};
static struct LCM_setting_table sharp_dispon[] = {
	/*display on*/
	{0x29, 1, {0}},
	{REGFLAG_DELAY, 0, {}},
	{REGFLAG_END_OF_TABLE, 0, {}},
};

static struct LCM_setting_table sharp_slpin[] = {
    // Sleep Mode On
    {0x10, 1, {0x00}},
    {REGFLAG_DELAY, 5, {}},

    {REGFLAG_END_OF_TABLE, 0x00, {}}
};

static struct LCM_setting_table sharp_dispoff[] = {
    // Sleep Mode On
    {0x28, 1, {0x00}},
    {REGFLAG_DELAY, 5, {}},

    {REGFLAG_END_OF_TABLE, 0x00, {}}
};


static struct LCM_setting_table sharp_slpin_dispoff[] = {
    // Display off sequence
    {0x28, 1, {0x00}},
    {REGFLAG_DELAY, 50, {}},

    // Sleep Mode On
    {0x10, 1, {0x00}},
    {REGFLAG_DELAY, 16, {}},

    {REGFLAG_END_OF_TABLE, 0x00, {}}
};

static struct LCM_setting_table sharp_slpout_dispon[] = {
	{0xB1, 1, {0x00}},
    {REGFLAG_DELAY, 2, {}},

	{0x11, 1, {0}},
	{REGFLAG_DELAY, 120, {}},
	{0x35, 1, {0}},
	{0x29, 1, {0}},
    {REGFLAG_END_OF_TABLE, 0x00, {}}
};
static struct LCM_setting_table sharp_stdby_in[] = {
	{0xB1, 1, {0x01}},
    {REGFLAG_END_OF_TABLE, 0x00, {}}
};

static struct LCM_setting_table sharp_stdby_out[] = {
	{0xB1, 1, {0x00}},
    {REGFLAG_DELAY, 2, {}},
    {REGFLAG_END_OF_TABLE, 0x00, {}}
};

// ---------------------------------------------------------------------------
//  LCM Driver Implementations
// ---------------------------------------------------------------------------

static void lcm_set_util_funcs(const LCM_UTIL_FUNCS *util)
{
    memcpy(&lcm_util, util, sizeof(LCM_UTIL_FUNCS));
}
static void push_table(struct LCM_setting_table *table, unsigned int count, unsigned char force_update)
{
    unsigned int i;

    for (i = 0; i < count; i++) {
        unsigned cmd;
        cmd = table[i].cmd;

        switch (cmd) {
        case REGFLAG_DELAY :
			if (table[i].count == 0)
				break;
            if(table[i].count <= 10) 
                UDELAY(table[i].count * 1000);
            else
                MDELAY(table[i].count);
            break;

        case REGFLAG_END_OF_TABLE :
            break;

        default:
            dsi_set_cmdq_V2(cmd, table[i].count, table[i].para_list, force_update);
        }
    }
}

static void lcm_power_switch_1st_stage(bool enable)
{
	if (enable) {
		SET_RESET_PIN(0);
#ifndef BUILD_LK
		pmic_ldo_vol_sel(MT6331_POWER_LDO_VMC, VOL_1800);
		pmic_ldo_enable(MT6331_POWER_LDO_VMC, KAL_TRUE);
#else
		mt6331_upmu_set_rg_vmc_vosel(0);
		mt6331_upmu_set_rg_vmc_en(1);
#endif	
		MDELAY(2);
		//VSP5V
        mt_set_gpio_out(GPIO_LCD_BIAS_ENP_PIN, GPIO_OUT_ONE);
		MDELAY(2);
        //VSN5V
        mt_set_gpio_out(GPIO_LCD_BIAS_ENN_PIN, GPIO_OUT_ONE);
		MDELAY(2);
		SET_RESET_PIN(1);
		MDELAY(60);
	} else {
		SET_RESET_PIN(0);
		MDELAY(1);
	    //VSN5V
        mt_set_gpio_out(GPIO_LCD_BIAS_ENN_PIN, GPIO_OUT_ZERO);
        MDELAY(1);
        //VSP5V
        mt_set_gpio_out(GPIO_LCD_BIAS_ENP_PIN, GPIO_OUT_ZERO);
        MDELAY(1);
#ifndef BUILD_LK
		pmic_ldo_enable(MT6331_POWER_LDO_VMC, KAL_FALSE);
#else
        mt6331_upmu_set_rg_vmc_en(0);
#endif
		MDELAY(100);
	}
}

static void lcm_power_switch_2nd_stage(bool enable)
{
	if (enable) {
		//VSP5V
        mt_set_gpio_out(GPIO_LCD_BIAS_VGH_PIN, GPIO_OUT_ONE);
		MDELAY(1);
        //VSN5V
        mt_set_gpio_out(GPIO_LCD_BIAS_VGL_PIN, GPIO_OUT_ONE);
	} else {
        mt_set_gpio_out(GPIO_LCD_BIAS_VGH_PIN, GPIO_OUT_ZERO);
        mt_set_gpio_out(GPIO_LCD_BIAS_VGL_PIN, GPIO_OUT_ZERO);
		MDELAY(2);
	}
}

static void lcm_get_params(LCM_PARAMS *params)
{
		memset(params, 0, sizeof(LCM_PARAMS));
	
		params->type   = LCM_TYPE_DSI;

		params->width  = FRAME_WIDTH;
		params->height = FRAME_HEIGHT;
		params->physical_width = 70;//69.984
		params->physical_height = 117;//116.64

#if (LCM_DSI_CMD_MODE)
		params->dsi.mode   = CMD_MODE;
#else
		//params->dsi.mode   = SYNC_PULSE_VDO_MODE;//SYNC_EVENT_VDO_MODE;//BURST_VDO_MODE;
		params->dsi.mode   = BURST_VDO_MODE;
#endif
		//params->dsi.esd_check_enable = 1;  //for esd test.

		// DSI
		/* Command mode setting */
		//1 Three lane or Four lane
		params->dsi.LANE_NUM				= LCM_FOUR_LANE;
		//The following defined the fomat for data coming from LCD engine.
		params->dsi.data_format.format      = LCM_DSI_FORMAT_RGB888;
		params->dsi.packet_size = 256;
		//params->dsi.clk_lp_per_line_enable = 1;
		// Video mode setting
		params->dsi.intermediat_buffer_num = 0;
		params->dsi.PS = LCM_PACKED_PS_24BIT_RGB888;
		params->dsi.word_count = FRAME_WIDTH * 3;
		
		params->dsi.vertical_sync_active				= 3;
		params->dsi.vertical_backporch					= 6;
		params->dsi.vertical_frontporch					= 56;
		params->dsi.vertical_active_line				= FRAME_HEIGHT;
		params->dsi.vertical_frontporch_for_low_power = 400; // for saving power in screen idle

		params->dsi.horizontal_sync_active				= 4; //+ backprot = 36
		params->dsi.horizontal_backporch				= 32;
		params->dsi.horizontal_frontporch				= 64;
		params->dsi.horizontal_active_pixel				= FRAME_WIDTH;

	    //params->dsi.LPX=8; 

		// Bit rate calculation
		params->dsi.PLL_CLOCK = 500;
		//1 Every lane speed
	//	params->dsi.pll_div1=0;		// div1=0,1,2,3;div1_real=1,2,4,4 ----0: 546Mbps  1:273Mbps
	//	params->dsi.pll_div2=0;		// div2=0,1,2,3;div1_real=1,2,4,4
	//	params->dsi.fbk_div =0x13;    // fref=26MHz, fvco=fref*(fbk_div+1)*2/(div1_real*div2_real)
}
static struct LCM_setting_table sharp_init_id[] = {
	{0xb9, 3,  {0xff,0x83,0x99}},
	{REGFLAG_DELAY, 10, {}},
	{REGFLAG_END_OF_TABLE, 0, {}},
};

static unsigned int id_code;
static void lcm_init(void)
{
	unsigned int array[16];
	unsigned char id_code_dc = 0xff;
	unsigned char id_code_c3[4] = {0,};
	int ret = 0;
#if 0
	mt_set_gpio_mode(GPIO_LCD_BIAS_ENP_PIN, GPIO_MODE_GPIO);
    mt_set_gpio_pull_enable(GPIO_LCD_BIAS_ENP_PIN, GPIO_PULL_ENABLE);
    mt_set_gpio_pull_select(GPIO_LCD_BIAS_ENP_PIN, GPIO_PULL_DOWN);

	mt_set_gpio_mode(GPIO_LCD_BIAS_ENN_PIN, GPIO_MODE_GPIO);
    mt_set_gpio_pull_enable(GPIO_LCD_BIAS_ENN_PIN, GPIO_PULL_ENABLE);
    mt_set_gpio_pull_select(GPIO_LCD_BIAS_ENN_PIN, GPIO_PULL_DOWN);
#endif

	lcm_power_switch_1st_stage(true);
#ifdef POWER_MODE_5
	lcm_power_switch_2nd_stage(true);
#endif
	push_table(sharp_init_id, sizeof(sharp_init_id)/sizeof(struct LCM_setting_table),1);


	read_reg_v2(0xDC, &id_code_dc, 1);
	read_reg_v2(0xC3, &id_code_c3, 4);
	lcm_print("id code 1, 0x%x\n", id_code_c3[0]);
	lcm_print("id code 2, 0x%x\n", id_code_c3[1]);
	lcm_print("id code 3, 0x%x\n", id_code_dc);
	id_code = (unsigned int)((id_code_dc | (id_code_c3[1] << 8) | (id_code_c3[0] << 16)));

	switch(id_code_dc) {
		case 0:
			push_table(sharp_init_code_id30,
					sizeof(sharp_init_code_id30)/sizeof(struct LCM_setting_table), 1);
			break;
		case 1:
			push_table(sharp_init_code_id31,
					sizeof(sharp_init_code_id30)/sizeof(struct LCM_setting_table), 1);
			break;
		case 2:
			push_table(sharp_init_code_id32,
					sizeof(sharp_init_code_id30)/sizeof(struct LCM_setting_table), 1);
			break;
		default:
			push_table(sharp_init_code_id31,
					sizeof(sharp_init_code_id30)/sizeof(struct LCM_setting_table), 1);
			break;
	}
	push_table(sharp_slpout,
		sizeof(sharp_slpout)/sizeof(struct LCM_setting_table), 1);
	push_table(sharp_dispon,
		sizeof(sharp_dispon)/sizeof(struct LCM_setting_table), 1);
}
#define LCM_POWER_ENABLE
static void lcm_suspend(void)
{
	push_table(sharp_slpin_dispoff,
		sizeof(sharp_slpin_dispoff)/sizeof(struct LCM_setting_table), 1);
#ifdef LCM_POWER_ENABLE
	lcm_power_switch_1st_stage(false);
#else
	MDELAY(60);
#endif
}

static void lcm_suspend_power(void)
{
	lcm_power_switch_1st_stage(false);
}
static void lcm_resume(void)
{
	lcm_print("resume @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@\n");
#ifdef LCM_POWER_ENABLE
	lcm_init();
	//push_table(sharp_slpout_dispon,
	//		sizeof(sharp_slpout_dispon)/sizeof(struct LCM_setting_table), 1);
#else
	push_table(sharp_slpout,
		sizeof(sharp_slpout)/sizeof(struct LCM_setting_table), 1);
	push_table(sharp_dispon,
		sizeof(sharp_dispon)/sizeof(struct LCM_setting_table), 1);
#endif
}
         
#if (LCM_DSI_CMD_MODE)
static void lcm_update(unsigned int x, unsigned int y,
                       unsigned int width, unsigned int height)
{
	unsigned int x0 = x;
	unsigned int y0 = y;
	unsigned int x1 = x0 + width - 1;
	unsigned int y1 = y0 + height - 1;

	unsigned char x0_MSB = ((x0>>8)&0xFF);
	unsigned char x0_LSB = (x0&0xFF);
	unsigned char x1_MSB = ((x1>>8)&0xFF);
	unsigned char x1_LSB = (x1&0xFF);
	unsigned char y0_MSB = ((y0>>8)&0xFF);
	unsigned char y0_LSB = (y0&0xFF);
	unsigned char y1_MSB = ((y1>>8)&0xFF);
	unsigned char y1_LSB = (y1&0xFF);

	unsigned int data_array[16];

	data_array[0]= 0x00053902;
	data_array[1]= (x1_MSB<<24)|(x0_LSB<<16)|(x0_MSB<<8)|0x2a;
	data_array[2]= (x1_LSB);
	dsi_set_cmdq(data_array, 3, 1);
	
	data_array[0]= 0x00053902;
	data_array[1]= (y1_MSB<<24)|(y0_LSB<<16)|(y0_MSB<<8)|0x2b;
	data_array[2]= (y1_LSB);
	dsi_set_cmdq(data_array, 3, 1);

	data_array[0]= 0x002c3909;
	dsi_set_cmdq(data_array, 1, 0);

}
#endif

static unsigned int lcm_compare_id(void)
{
	return id_code;
}

LCM_DRIVER hx8399_fhd_dsi_vdo_sharp_lcm_drv = 
{
    .name			= "hx8399_fhd_dsi_vdo_sharp",
	.set_util_funcs = lcm_set_util_funcs,
	.get_params     = lcm_get_params,
	.init           = lcm_init,
	.suspend        = lcm_suspend,
#ifdef BUILD_LK
	.suspend_power  = lcm_suspend_power,
#endif
	.resume         = lcm_resume,
	.compare_id     = lcm_compare_id,
#if (LCM_DSI_CMD_MODE)
    .update         = lcm_update,
#endif
};
